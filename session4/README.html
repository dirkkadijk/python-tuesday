<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta charset="utf-8"/>
<meta name="generator" content="Docutils 0.14: http://docutils.sourceforge.net/" />
<title>Working with Data Part 2: Introduction to Relational Databases</title>
<meta name="author" content="Gábor Nyers" />
<style type="text/css">

/*
 * CSS
 */

html{
  background: #ffffff;
}

@media (max-width: 400px) {
  html {
    /* background: #ffcccc;  */
    font-size: 10px;
  }
}
@media (min-width: 401px) and (max-width: 800px) {
  html {
    /* background: #ccffcc; */
    font-size: 14px;
  }
}
@media (min-width: 801px) {
  html {
    /* background: #ccccff; */
    font-size: 20px;
    max-width: 1024px;
    margin: auto;
  }
}

.content {
  background: #c3c3c3;
}

h1, h2, h3 {
  border-bottom: 1pt #00ff00;
}

h1 {
  font-size: 1.4rem;
}

.topic-title {
  font-size: 1.4rem;
}


p {
  margin: 0.5em;
}

img {
  max-width: 100%;
}

a {
  border: none;
}

dl {
  padding: 0.2em;
}
dt {
  float: left;
  clear: left;
  max-width: 200px;
  text-align: right;
  font-weight: bold;
  background: #f0f0f0;
  color: #222222;
  padding: 0 5px 0 5px;
}
dt::after {
  content: ": ";
}
dd {
  margin: 0 0 0 120px;
  padding: 0 0 0.5em 0;
  padding: 0 5px 0 5px;
}

dd p {
  margin: 0 0 0 0;
}

.caption {
  font-style: italic;
}

.style2 td {
  border: 1px solid;
  vertical-align: top;
}

/* BEGIN */
pre, .literal {
  margin: 0.5em;
  background: #f0f0f0;
  font: 0.92rem Inconsolata, monospace;
  color: #222222;
  text-shadow: 0 0 5px #C8C8C8;
  white-space: pre-wrap;
  word-wrap: break-word;
}
::selection {
  background: #0080FF;
  text-shadow: none;
}
.ln, .prompt {
  -webkit-user-select: none;  /* Chrome all / Safari all */
  -moz-user-select: none;     /* Firefox all */
  -ms-user-select: none;      /* IE 10+ */
}
/*  END */


/*
vim: filetype=css textwidth=78 foldmethod=syntax foldcolumn=3 wrap
vim: linebreak ruler spell spelllang=en showbreak=… shiftwidth=2
vim: softtabstop=2 tabstop=2
*/


</style>
</head>
<body>
<div class="document" id="working-with-data-part-2-introduction-to-relational-databases">
<h1 class="title">Working with Data Part 2: Introduction to Relational Databases</h1>

<p class="subtitle" id="python-tuesday-session-4">Python Tuesday: Session 4</p>
<dl class="docinfo simple">
<dt class="date">Date</dt>
<dd class="date">2019-10-13</dd>
<dt class="author">Author</dt>
<dd class="author"><p>Gábor Nyers</p></dd>
<dt class="tags">tags</dt>
<dd class="tags"><p>python</p>
</dd>
<dt class="category">category</dt>
<dd class="category"><p>python_workshop</p>
</dd>
<dt class="summary">summary</dt>
<dd class="summary"><p>Reading from and writing data to databases</p>
</dd>
<dt class="licence">licence</dt>
<dd class="licence"><p>CC BY-NC 4.0 <a class="reference external" href="https://creativecommons.org/licenses/by-nc/4.0/">https://creativecommons.org/licenses/by-nc/4.0/</a></p>
</dd>
</dl>
<div class="contents local topic" id="contents">
<p class="topic-title first">Contents:</p>
<ul class="auto-toc simple">
<li><p><a class="reference internal" href="#introduction" id="id23"><span class="sectnum">1.</span> Introduction</a></p></li>
<li><p><a class="reference internal" href="#preparations" id="id24"><span class="sectnum">2.</span> Preparations</a></p>
<ul class="auto-toc">
<li><p><a class="reference internal" href="#earlier-sessions" id="id25"><span class="sectnum">2.1.</span> Earlier sessions</a></p></li>
<li><p><a class="reference internal" href="#this-session-s-material" id="id26"><span class="sectnum">2.2.</span> This session's material</a></p></li>
<li><p><a class="reference internal" href="#requirements" id="id27"><span class="sectnum">2.3.</span> Requirements</a></p></li>
<li><p><a class="reference internal" href="#useful-tools" id="id28"><span class="sectnum">2.4.</span> Useful tools</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#the-scope" id="id29"><span class="sectnum">3.</span> The scope</a></p>
<ul class="auto-toc">
<li><p><a class="reference internal" href="#topics-inside-of-the-scope" id="id30"><span class="sectnum">3.1.</span> Topics inside of the scope</a></p></li>
<li><p><a class="reference internal" href="#topics-outside-of-the-scope" id="id31"><span class="sectnum">3.2.</span> Topics outside of the scope</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#concepts" id="id32"><span class="sectnum">4.</span> Concepts</a></p>
<ul class="auto-toc">
<li><p><a class="reference internal" href="#access-to-databases-via-db-api-driver" id="id33"><span class="sectnum">4.1.</span> Access to databases via DB API driver</a></p></li>
<li><p><a class="reference internal" href="#database-cursor" id="id34"><span class="sectnum">4.2.</span> Database Cursor</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#working-with-sql-databases" id="id35"><span class="sectnum">5.</span> Working with SQL databases</a></p>
<ul class="auto-toc">
<li><p><a class="reference internal" href="#the-generic-steps-to-interact-with-a-sql-database" id="id36"><span class="sectnum">5.1.</span> The generic steps to interact with a SQL database</a></p></li>
<li><p><a class="reference internal" href="#connect-to-a-database" id="id37"><span class="sectnum">5.2.</span> Connect to a database</a></p></li>
<li><p><a class="reference internal" href="#id13" id="id38"><span class="sectnum">5.3.</span> Create a cursor object</a></p></li>
<li><p><a class="reference internal" href="#construct-the-sql-statement" id="id39"><span class="sectnum">5.4.</span> Construct the SQL Statement</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#database-differences" id="id40"><span class="sectnum">6.</span> Database differences</a></p></li>
<li><p><a class="reference internal" href="#database-independent-python-applications" id="id41"><span class="sectnum">7.</span> Database-independent Python applications</a></p></li>
<li><p><a class="reference internal" href="#other-useful-howtos-and-tutorials" id="id42"><span class="sectnum">8.</span> Other useful HOWTOs and tutorials</a></p></li>
<li><p><a class="reference internal" href="#showcase-application-time-sheet" id="id43"><span class="sectnum">9.</span> Showcase Application: Time sheet</a></p>
<ul class="auto-toc">
<li><p><a class="reference internal" href="#features" id="id44"><span class="sectnum">9.1.</span> Features</a></p></li>
<li><p><a class="reference internal" href="#implementation-decisions" id="id45"><span class="sectnum">9.2.</span> Implementation decisions</a></p></li>
<li><p><a class="reference internal" href="#usage" id="id46"><span class="sectnum">9.3.</span> Usage</a></p></li>
<li><p><a class="reference internal" href="#implementation-highlights" id="id47"><span class="sectnum">9.4.</span> Implementation highlights</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#references" id="id48"><span class="sectnum">10.</span> References</a></p></li>
</ul>
</div>
<div class="section" id="introduction">
<h1><a class="toc-backref" href="#id23"><span class="sectnum">1.</span> Introduction</a></h1>
<p>The topic of this workshop is to examine the many ways how we can interact
with <strong>relational databases</strong> from Python.</p>
<p>Relational databases are used for:</p>
<ul class="simple">
<li><p><strong>data storage abstraction</strong>: Clear separation of application code and
data for purposes of: concurrent access, performance, security etc...</p></li>
<li><p><strong>structured data storage</strong>: Relational database software enforces
a predefined structure of the data (schema)</p></li>
<li><p><strong>data storage and retrieval</strong>: Relational databases typically use the
&quot;Structured Query Language&quot; (see <a class="citation-reference" href="#sqllang" id="id1">[SQLLang]</a>) to store and retrieve data from
the database. SQL is a programming language with an English-like vocabulary.</p></li>
</ul>
</div>
<div class="section" id="preparations">
<h1><a class="toc-backref" href="#id24"><span class="sectnum">2.</span> Preparations</a></h1>
<div class="section" id="earlier-sessions">
<h2><a class="toc-backref" href="#id25"><span class="sectnum">2.1.</span> Earlier sessions</a></h2>
<p>As we will build upon the previous topics, you might want to review the
earlier sessions:</p>
<ul class="simple">
<li><p>session 1: Getting your environment set up and ready for Python development
<a class="reference external" href="https://github.com/gnyers/python-tuesday/tree/master/session1">https://github.com/gnyers/python-tuesday/tree/master/session1</a></p></li>
<li><p>session 2: Working with text files and file formats
<a class="reference external" href="https://github.com/gnyers/python-tuesday/tree/master/session2">https://github.com/gnyers/python-tuesday/tree/master/session2</a></p></li>
<li><p>session 3: Working with data, part 1: spreadsheets
<a class="reference external" href="https://github.com/gnyers/python-tuesday/tree/master/session3">https://github.com/gnyers/python-tuesday/tree/master/session3</a></p></li>
</ul>
</div>
<div class="section" id="this-session-s-material">
<h2><a class="toc-backref" href="#id26"><span class="sectnum">2.2.</span> This session's material</a></h2>
<p>Visit this page: <a class="reference external" href="https://github.com/gnyers/python-tuesday/tree/master/session4">https://github.com/gnyers/python-tuesday/tree/master/session4</a></p>
<p>OR</p>
<p>Check out the Git repo:</p>
<pre class="code shell literal-block"><code><span class="name builtin">cd</span> <span class="name variable">$PROJECTDIR</span>
git clone git&#64;github.com:gnyers/python-tuesday.git</code></pre>
<p>To follow along with the instructions please open the README.html in your
browser:</p>
<pre class="code shell literal-block"><code>firefox <span class="name variable">$PROJECTDIR</span>/python-tuesday/session4/README.html</code></pre>
</div>
<div class="section" id="requirements">
<h2><a class="toc-backref" href="#id27"><span class="sectnum">2.3.</span> Requirements</a></h2>
<p>The code of this workshop has been tested with:</p>
<ul>
<li><p>Python v3.6 and</p></li>
<li><p>the following modules that are not part of the Python Standard Library:</p>
<ul class="simple">
<li><p><span class="docutils literal">sqlite3</span>: module to read/write SQLite databases</p></li>
<li><p><span class="docutils literal">ptpython</span>: a very convenient Python interactive shell with support for
in-line sytax highlighting, command completion and improved code editing</p></li>
</ul>
<p>To install these modules execute:</p>
<pre class="code shell literal-block"><code>pip install --user -r requirements.txt</code></pre>
</li>
</ul>
</div>
<div class="section" id="useful-tools">
<h2><a class="toc-backref" href="#id28"><span class="sectnum">2.4.</span> Useful tools</a></h2>
<p>The following tools can help to deal with databases:</p>
<ul>
<li><p>Python DB CLI tools: <span class="docutils literal">litecli</span> (SQLite), <span class="docutils literal">mycli</span> (MariaDB) and <span class="docutils literal">pgcli</span>
(PostgreSQL)</p>
<p>To install these modules execute:</p>
<pre class="code shell literal-block"><code>pip install --user -r requirements-dbcli.txt</code></pre>
</li>
<li><p>DBeaver: an open source GUI database tool for multiple databases:
<a class="reference external" href="https://dbeaver.io/">https://dbeaver.io/</a></p></li>
<li><p>DBDesigner: an on-line database schema design tool
<a class="reference external" href="https://www.dbdesigner.net/">https://www.dbdesigner.net/</a></p></li>
</ul>
</div>
</div>
<div class="section" id="the-scope">
<h1><a class="toc-backref" href="#id29"><span class="sectnum">3.</span> The scope</a></h1>
<p>Like in most other programming languages, databases are a huge topic in Python
as well. So we'll need to restrict our scope.</p>
<div class="section" id="topics-inside-of-the-scope">
<h2><a class="toc-backref" href="#id30"><span class="sectnum">3.1.</span> Topics inside of the scope</a></h2>
<ul class="simple">
<li><p>Working with relational databases, such as: SQLite, MariaDB / MySQL and
PostgreSQL</p></li>
<li><p>Required Python modules</p></li>
<li><p>Connecting to a Database</p></li>
<li><p>Create a database</p></li>
<li><p>Create a table</p></li>
<li><p>Insert data</p></li>
<li><p>Query information</p></li>
<li><p>Update data</p></li>
<li><p>Delete data</p></li>
</ul>
</div>
<div class="section" id="topics-outside-of-the-scope">
<h2><a class="toc-backref" href="#id31"><span class="sectnum">3.2.</span> Topics outside of the scope</a></h2>
<p>The following topics are assumed to be known:</p>
<ul class="simple">
<li><p>Introduction to SQL (see <a class="citation-reference" href="#sqllang" id="id2">[SQLLang]</a>)</p></li>
<li><p>Discussion of the <a class="citation-reference" href="#acid" id="id3">[ACID]</a> considerations</p></li>
<li><p>DB management basics using <a class="citation-reference" href="#mariadb" id="id4">[MariaDB]</a> or <a class="citation-reference" href="#id22" id="id5">[PostgreSQL]</a></p></li>
</ul>
<p>These topics are related to databases, but not discussed in this session:</p>
<ul class="simple">
<li><p>Object-Relational Mapping (ORM) software, such as <a class="citation-reference" href="#sqlalchemy" id="id6">[SQLAlchemy]</a>,
<a class="citation-reference" href="#djangoorm" id="id7">[DjangoORM]</a>, <a class="citation-reference" href="#peeweeorm" id="id8">[PeeweeORM]</a></p></li>
<li><p>NoSQL databases, such as MongoDB, Redis</p></li>
</ul>
</div>
</div>
<div class="section" id="concepts">
<h1><a class="toc-backref" href="#id32"><span class="sectnum">4.</span> Concepts</a></h1>
<div class="section" id="access-to-databases-via-db-api-driver">
<h2><a class="toc-backref" href="#id33"><span class="sectnum">4.1.</span> Access to databases via DB API driver</a></h2>
<p>Similar to other programming languages and applications, accessing databases
from Python will require some middleware. The different layers when accessing
a database:</p>
<table class="style2">
<colgroup>
<col style="width: 27%" />
<col style="width: 38%" />
<col style="width: 35%" />
</colgroup>
<tbody>
<tr><td rowspan="3"><p>Client side</p></td>
<td colspan="2"><p>Python Application</p></td>
</tr>
<tr><td><p>DB-API driver
(e.g. sqlite3,
mysql-connect)</p></td>
<td rowspan="2"><p>Pure Python
DB-API driver</p>
<p>(e.g.: PyMySQL)</p>
</td>
</tr>
<tr><td><p>Native DB-API
Driver</p></td>
</tr>
<tr><td><p>Server side</p></td>
<td colspan="2"><p>Database Software (RDBMS)</p></td>
</tr>
</tbody>
</table>
<p>This middleware needs to implement the specifications of DB API, which is
described in <a class="citation-reference" href="#pep249" id="id9">[PEP249]</a>. In general the responsibilities are the following:</p>
<ul class="simple">
<li><p>establishing a connection either through network, socket or some other
mechanism.</p></li>
<li><p>executing SQL statements</p></li>
<li><p>fetching the results</p></li>
</ul>
<p>Usually the Python database drivers are wrappers around existing (mostly C)
libraries. There are, however, a few exceptions that are completely written in
Python (e.g. PyMySQL)</p>
<p>The Python Wiki (see <a class="citation-reference" href="#pysupporteddbs" id="id10">[PySupportedDBs]</a>) provides an overview of the database
products that have a Python database driver. A few examples: IBM DB2, Firebird
(and Interbase), Informix, Ingres, MariaDB / MySQL, Oracle, PostgreSQL, MaxDB,
Microsoft SQL Server, Microsoft Access, Sybase,</p>
</div>
<div class="section" id="database-cursor">
<h2><a class="toc-backref" href="#id34"><span class="sectnum">4.2.</span> Database Cursor</a></h2>
<p>A database cursor represents the results of some SQL transaction, which can be
fetched and manipulated from Python.</p>
<p><strong>Note:</strong> a cursor is a snapshot of the state of the database at the end of
aforementioned SQL transaction. In case of multiuser/multithreaded database
products (i.e. the majority) this snapshot may not be up-to-date anymore, as
the consequence of the <a class="citation-reference" href="#acid" id="id11">[ACID]</a> requirements.</p>
</div>
</div>
<div class="section" id="working-with-sql-databases">
<h1><a class="toc-backref" href="#id35"><span class="sectnum">5.</span> Working with SQL databases</a></h1>
<div class="section" id="the-generic-steps-to-interact-with-a-sql-database">
<h2><a class="toc-backref" href="#id36"><span class="sectnum">5.1.</span> The generic steps to interact with a SQL database</a></h2>
<ol class="arabic">
<li><p><a class="reference external" href="#connect-to-a-db">Connect to the database</a> using a DB API
compatible driver</p></li>
<li><p><a class="reference external" href="#create-a-cursor">Create a cursor object</a></p></li>
<li><p><a class="reference external" href="#construct-sql">Construct a SQL statement</a></p>
<p>The statement is often constructed by combining a template and some data,
which is either provided by a user or acquired by Python some other way</p>
</li>
<li><p>Execute the SQL statement</p>
<p>Submit the SQL statement to the database through the cursor object's
<span class="docutils literal">.execute()</span> method. The result is a cursor object.</p>
</li>
<li><p>Process the results by iterating through the cursor.</p></li>
</ol>
</div>
<div class="section" id="connect-to-a-database">
<span id="connect-to-a-db"></span><h2><a class="toc-backref" href="#id37"><span class="sectnum">5.2.</span> Connect to a database</a></h2>
<div class="section" id="sqlite">
<h3>SQlite</h3>
<p>Connect to a SQLite database represented by the file <span class="docutils literal">test.db</span>:</p>
<pre class="code python python-interactive literal-block"><code><span class="ln">1 </span><span class="operator">&gt;&gt;&gt;</span> <span class="keyword namespace">import</span> <span class="name namespace">sqlite3</span>
<span class="ln">2 </span><span class="operator">&gt;&gt;&gt;</span>
<span class="ln">3 </span><span class="operator">&gt;&gt;&gt;</span> <span class="name">conn1</span> <span class="operator">=</span> <span class="name">sqlite3</span><span class="operator">.</span><span class="name">connect</span><span class="punctuation">(</span><span class="literal string single">'test.db'</span><span class="punctuation">)</span></code></pre>
<ul>
<li><p><strong>line 1:</strong> load the <span class="docutils literal">sqlite3</span> module</p></li>
<li><p><strong>line 3:</strong> create a connection object to the SQLite database in file
<span class="docutils literal">test.db</span></p>
<p><strong>Note:</strong> if the <span class="docutils literal">test.db</span> database will be created automatically as an
empty database if it did not exist.</p>
</li>
</ul>
</div>
<div class="section" id="mariadb-mysql">
<h3>MariaDB / MySQL</h3>
<p>The below steps assume that the database server already has the user
<span class="docutils literal">pyuser</span> and the database <span class="docutils literal">pydb</span>. The <span class="docutils literal">pyuser</span> has full privileges in
the <span class="docutils literal">pydb</span> database.</p>
<p>The <span class="docutils literal"><span class="pre">req-mariadb.sql</span></span> script will create these requirements on the
database server:</p>
<pre class="code shell literal-block"><code>mysql -u root &lt; req-mariadb.sql</code></pre>
<p>To connect to a MariaDB database, we need a bit more information:</p>
<pre class="code python python-interactive literal-block"><code><span class="ln">1 </span><span class="operator">&gt;&gt;&gt;</span> <span class="keyword namespace">import</span> <span class="name namespace">pymysql</span>
<span class="ln">2 </span><span class="operator">&gt;&gt;&gt;</span>
<span class="ln">3 </span><span class="operator">&gt;&gt;&gt;</span> <span class="name">conn2</span> <span class="operator">=</span> <span class="name">pymysql</span><span class="operator">.</span><span class="name">connect</span><span class="punctuation">(</span><span class="name">host</span><span class="operator">=</span><span class="literal string single">'localhost'</span><span class="punctuation">,</span>
<span class="ln">4 </span><span class="operator">...</span>                         <span class="name">db</span><span class="operator">=</span><span class="literal string single">'pydb'</span><span class="punctuation">,</span>
<span class="ln">5 </span><span class="operator">...</span>                         <span class="name">user</span><span class="operator">=</span><span class="literal string single">'pyuser'</span><span class="punctuation">,</span>
<span class="ln">6 </span><span class="operator">...</span>                         <span class="name">password</span><span class="operator">=</span><span class="literal string single">'password'</span><span class="punctuation">)</span></code></pre>
<ul>
<li><p><strong>line 1:</strong> load the <span class="docutils literal">pymysql</span> (<a class="citation-reference" href="#pymysql" id="id12">[PyMySQL]</a>) module</p></li>
<li><p><strong>line 3:</strong> create a connection object to the MariaDB instance as user
<span class="docutils literal">pyuser</span> with the password <span class="docutils literal">password</span> on the local system on the default
port (3306) and using the usual defaults. Use the <span class="docutils literal">pydb</span> database.</p>
<p>For a complete list of arguments to the <span class="docutils literal">.connect()</span> method see
<span class="docutils literal">help(pymysql.connections.Connection)</span></p>
</li>
</ul>
</div>
<div class="section" id="postgresql">
<h3>PostgreSQL</h3>
<p>The below steps assume that the database server already has the user
<span class="docutils literal">pyuser</span> and the database <span class="docutils literal">pydb</span>. The <span class="docutils literal">pyuser</span> has full privileges in
the <span class="docutils literal">pydb</span> database.</p>
<p>The <span class="docutils literal"><span class="pre">req-postgresql.sql</span></span> script will create these requirements on the
database server:</p>
<pre class="code shell literal-block"><code>sudo postgres psql &lt; req-postgresql.sql</code></pre>
<p>Connect to a PostgreSQL database:</p>
<pre class="code python python-interactive literal-block"><code><span class="ln">1 </span><span class="operator">&gt;&gt;&gt;</span> <span class="keyword namespace">import</span> <span class="name namespace">psycopg2</span>
<span class="ln">2 </span><span class="operator">&gt;&gt;&gt;</span>
<span class="ln">3 </span><span class="operator">&gt;&gt;&gt;</span> <span class="name">conn3</span> <span class="operator">=</span> <span class="name">psycopg2</span><span class="operator">.</span><span class="name">connect</span><span class="punctuation">(</span><span class="name">host</span><span class="operator">=</span><span class="literal string single">'localhost'</span><span class="punctuation">,</span>     <span class="comment single"># doctest: +SKIP</span>
<span class="ln">4 </span><span class="operator">...</span>                           <span class="name">database</span><span class="operator">=</span><span class="literal string single">'pydb'</span><span class="punctuation">,</span>
<span class="ln">5 </span><span class="operator">...</span>                           <span class="name">user</span><span class="operator">=</span><span class="literal string single">'pyuser'</span><span class="punctuation">,</span>
<span class="ln">6 </span><span class="operator">...</span>                           <span class="name">password</span><span class="operator">=</span><span class="literal string single">'password'</span><span class="punctuation">)</span></code></pre>
</div>
</div>
<div class="section" id="id13">
<span id="create-a-cursor"></span><h2><a class="toc-backref" href="#id38"><span class="sectnum">5.3.</span> Create a cursor object</a></h2>
<p>The cursor object will be used to submit SQL statements to the database and
retrieve the results.</p>
<p>Use of multiple cursor objects through the same connection is possible, but
keep in mind that the result of the same query may be different. This is
a consequence of the fact that cursors are different point-in-time snapshot of
the database.</p>
<p>Note the similarities in dealing with different databases! This is due to the
fact that the drivers implemented according the <a class="citation-reference" href="#pep249" id="id14">[PEP249]</a> specifications.</p>
<div class="section" id="id15">
<h3>SQLite</h3>
<pre class="code python python-interactive literal-block"><code><span class="ln"> 4 </span><span class="operator">&gt;&gt;&gt;</span> <span class="name">cur1</span> <span class="operator">=</span> <span class="name">conn1</span><span class="operator">.</span><span class="name">cursor</span><span class="punctuation">()</span>
<span class="ln"> 5 </span><span class="operator">&gt;&gt;&gt;</span> <span class="punctuation">[</span> <span class="name">attr</span>                          <span class="comment single"># new element of the list</span>
<span class="ln"> 6 </span><span class="operator">...</span>   <span class="keyword">for</span> <span class="name">attr</span> <span class="operator word">in</span> <span class="name builtin">dir</span><span class="punctuation">(</span><span class="name">cur1</span><span class="punctuation">)</span>         <span class="comment single"># loop through the attributes of `cur1`</span>
<span class="ln"> 7 </span><span class="operator">...</span>   <span class="keyword">if</span> <span class="operator word">not</span> <span class="name">attr</span><span class="operator">.</span><span class="name">startswith</span><span class="punctuation">(</span><span class="literal string single">'__'</span><span class="punctuation">)</span>  <span class="comment single"># only if attr does not start with '__'</span>
<span class="ln"> 8 </span><span class="operator">...</span> <span class="punctuation">]</span>                               <span class="comment single">#     doctest:+NORMALIZE_WHITESPACE</span>
<span class="ln"> 9 </span><span class="punctuation">[</span><span class="literal string single">'arraysize'</span><span class="punctuation">,</span> <span class="literal string single">'close'</span><span class="punctuation">,</span> <span class="literal string single">'connection'</span><span class="punctuation">,</span> <span class="literal string single">'description'</span><span class="punctuation">,</span> <span class="literal string single">'execute'</span><span class="punctuation">,</span>
<span class="ln">10 </span><span class="literal string single">'executemany'</span><span class="punctuation">,</span> <span class="literal string single">'executescript'</span><span class="punctuation">,</span> <span class="literal string single">'fetchall'</span><span class="punctuation">,</span> <span class="literal string single">'fetchmany'</span><span class="punctuation">,</span> <span class="literal string single">'fetchone'</span><span class="punctuation">,</span>
<span class="ln">11 </span><span class="literal string single">'lastrowid'</span><span class="punctuation">,</span> <span class="literal string single">'row_factory'</span><span class="punctuation">,</span> <span class="literal string single">'rowcount'</span><span class="punctuation">,</span> <span class="literal string single">'setinputsizes'</span><span class="punctuation">,</span> <span class="literal string single">'setoutputsize'</span><span class="punctuation">]</span></code></pre>
<ul class="simple">
<li><p><strong>line 4:</strong> create a cursor object, which can be used to submit SQL
statements to the database</p></li>
<li><p><strong>line 5:</strong> get list of attributes of the cursor object:</p>
<ul>
<li><p>data attributes: <span class="docutils literal">.arraysize</span>, <span class="docutils literal">.description</span>, <span class="docutils literal">.lastrowid</span>,
<span class="docutils literal">.rowfactory</span>, <span class="docutils literal">.rowcount</span></p></li>
<li><p>methods: <span class="docutils literal">.close()</span>, <span class="docutils literal">.execute()</span>, <span class="docutils literal">.executemany()</span>,
<span class="docutils literal">.executescript()</span>, <span class="docutils literal">.fetchall()</span>, <span class="docutils literal">fetchmany()</span>, <span class="docutils literal">fetchone()</span>,
<span class="docutils literal">.setinputsizes()</span>, <span class="docutils literal">.setoutputsize()</span></p></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="id16">
<h3>MariaDB / MySQL</h3>
<pre class="code python python-interactive literal-block"><code><span class="ln"> 7 </span><span class="operator">&gt;&gt;&gt;</span> <span class="name">cur2</span> <span class="operator">=</span> <span class="name">conn2</span><span class="operator">.</span><span class="name">cursor</span><span class="punctuation">()</span>
<span class="ln"> 8 </span><span class="operator">&gt;&gt;&gt;</span> <span class="punctuation">[</span> <span class="name">attr</span>
<span class="ln"> 9 </span><span class="operator">...</span>   <span class="keyword">for</span> <span class="name">attr</span> <span class="operator word">in</span> <span class="name builtin">dir</span><span class="punctuation">(</span><span class="name">cur2</span><span class="punctuation">)</span>
<span class="ln">10 </span><span class="operator">...</span>   <span class="keyword">if</span> <span class="operator word">not</span> <span class="name">attr</span><span class="operator">.</span><span class="name">startswith</span><span class="punctuation">(</span><span class="literal string single">'__'</span><span class="punctuation">)</span>
<span class="ln">11 </span><span class="operator">...</span> <span class="punctuation">]</span>                               <span class="comment single"># doctest: +NORMALIZE_WHITESPACE</span>
<span class="ln">12 </span><span class="punctuation">[</span><span class="literal string single">'DataError'</span><span class="punctuation">,</span> <span class="literal string single">'DatabaseError'</span><span class="punctuation">,</span> <span class="literal string single">'Error'</span><span class="punctuation">,</span> <span class="literal string single">'IntegrityError'</span><span class="punctuation">,</span> <span class="literal string single">'InterfaceError'</span><span class="punctuation">,</span>
<span class="ln">13 </span><span class="literal string single">'InternalError'</span><span class="punctuation">,</span> <span class="literal string single">'NotSupportedError'</span><span class="punctuation">,</span> <span class="literal string single">'OperationalError'</span><span class="punctuation">,</span>
<span class="ln">14 </span><span class="literal string single">'ProgrammingError'</span><span class="punctuation">,</span> <span class="literal string single">'Warning'</span><span class="punctuation">,</span> <span class="literal string single">'_check_executed'</span><span class="punctuation">,</span> <span class="literal string single">'_clear_result'</span><span class="punctuation">,</span>
<span class="ln">15 </span><span class="literal string single">'_conv_row'</span><span class="punctuation">,</span> <span class="literal string single">'_defer_warnings'</span><span class="punctuation">,</span> <span class="literal string single">'_do_execute_many'</span><span class="punctuation">,</span> <span class="literal string single">'_do_get_result'</span><span class="punctuation">,</span>
<span class="ln">16 </span><span class="literal string single">'_ensure_bytes'</span><span class="punctuation">,</span> <span class="literal string single">'_escape_args'</span><span class="punctuation">,</span> <span class="literal string single">'_executed'</span><span class="punctuation">,</span> <span class="literal string single">'_get_db'</span><span class="punctuation">,</span> <span class="literal string single">'_nextset'</span><span class="punctuation">,</span>
<span class="ln">17 </span><span class="literal string single">'_query'</span><span class="punctuation">,</span> <span class="literal string single">'_result'</span><span class="punctuation">,</span> <span class="literal string single">'_rows'</span><span class="punctuation">,</span> <span class="literal string single">'_show_warnings'</span><span class="punctuation">,</span> <span class="literal string single">'_warnings_handled'</span><span class="punctuation">,</span>
<span class="ln">18 </span><span class="literal string single">'arraysize'</span><span class="punctuation">,</span> <span class="literal string single">'callproc'</span><span class="punctuation">,</span> <span class="literal string single">'close'</span><span class="punctuation">,</span> <span class="literal string single">'connection'</span><span class="punctuation">,</span> <span class="literal string single">'description'</span><span class="punctuation">,</span> <span class="literal string single">'execute'</span><span class="punctuation">,</span>
<span class="ln">19 </span><span class="literal string single">'executemany'</span><span class="punctuation">,</span> <span class="literal string single">'fetchall'</span><span class="punctuation">,</span> <span class="literal string single">'fetchmany'</span><span class="punctuation">,</span> <span class="literal string single">'fetchone'</span><span class="punctuation">,</span> <span class="literal string single">'max_stmt_length'</span><span class="punctuation">,</span>
<span class="ln">20 </span><span class="literal string single">'mogrify'</span><span class="punctuation">,</span> <span class="literal string single">'nextset'</span><span class="punctuation">,</span> <span class="literal string single">'rowcount'</span><span class="punctuation">,</span> <span class="literal string single">'rownumber'</span><span class="punctuation">,</span> <span class="literal string single">'scroll'</span><span class="punctuation">,</span> <span class="literal string single">'setinputsizes'</span><span class="punctuation">,</span>
<span class="ln">21 </span><span class="literal string single">'setoutputsizes'</span><span class="punctuation">]</span></code></pre>
<ul>
<li><p><strong>line 7:</strong> create a cursor object</p></li>
<li><p><strong>line 8:</strong> get a list of attributes of the cursor object.</p>
<p><strong>Note:</strong> that on a MariaDB cursor there much more attributes, but there are
a few that are the same, i.e.: those that are specified by <a class="citation-reference" href="#pep249" id="id17">[PEP249]</a></p>
</li>
</ul>
</div>
</div>
<div class="section" id="construct-the-sql-statement">
<span id="construct-sql"></span><h2><a class="toc-backref" href="#id39"><span class="sectnum">5.4.</span> Construct the SQL Statement</a></h2>
<p>Relational database products use the SQL language to query or change the data.
So this is what Python applications will need to do as well.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>direct SQL statements vs. ORM</p>
<p>Python programmers often use an Object-Relational-Mapper (ORM) to interact
with a database. In this approach the application programmer writes Python
code and the ORM layer translates the instructions to SQL statements.</p>
<p>In this session we're focusing on how to using SQL statements directly,
which has the following pro's and con's:</p>
<p>Benefits:</p>
<ul class="simple">
<li><p>Since SQL is often understood by programmers, there is no need to learn
the (otherwise non-trivial) ORM layer.</p></li>
<li><p>Database queries and transactions can be optimized by knowledgeable
database administrators, who don't need to know Python.</p></li>
</ul>
<p>Drawbacks:</p>
<ul class="simple">
<li><p>SQL dialects, i.e.: databases usually employ some extended version of
SQL.  Changing an application to support a different or an additional
database product may cost significant effort.</p></li>
<li><p>Maintaining or changing application functions may require additional
database expertise.</p></li>
</ul>
</div>
<div class="section" id="sql-statements-are-strings">
<h3>SQL statements are strings</h3>
<p><strong>Example 1:</strong> Simplest SQL example: as-is</p>
<pre class="code python python-interactive literal-block"><code><span class="ln">1 </span><span class="operator">&gt;&gt;&gt;</span> <span class="name">create_tbl_users</span> <span class="operator">=</span> <span class="literal string single">'''
</span><span class="ln">2 </span><span class="literal string single">... CREATE TABLE users (
</span><span class="ln">3 </span><span class="literal string single">...    id INT AUTO_INCREMENT,
</span><span class="ln">4 </span><span class="literal string single">...    fname VARCHAR(40),
</span><span class="ln">5 </span><span class="literal string single">...    sname VARCHAR(60),
</span><span class="ln">6 </span><span class="literal string single">...    email VARCHAR(255),
</span><span class="ln">7 </span><span class="literal string single">...    PRIMARY KEY (id)
</span><span class="ln">8 </span><span class="literal string single">... );'''</span></code></pre>
</div>
<div class="section" id="sql-statements-with-string-formatting">
<h3>SQL statements with string formatting</h3>
<p><strong>Example 2:</strong> Make table name configurable with string formatting</p>
<pre class="code python python-interactive literal-block"><code><span class="ln"> 1 </span><span class="operator">&gt;&gt;&gt;</span> <span class="name">tblname</span> <span class="operator">=</span> <span class="literal string single">'users'</span>
<span class="ln"> 2 </span><span class="operator">&gt;&gt;&gt;</span> <span class="name">create_tbl_users</span> <span class="operator">=</span> <span class="literal string single">'''CREATE TABLE {table_name} (
</span><span class="ln"> 3 </span><span class="literal string single">...    id INT AUTO_INCREMENT,
</span><span class="ln"> 4 </span><span class="literal string single">...    fname VARCHAR(40),
</span><span class="ln"> 5 </span><span class="literal string single">...    sname VARCHAR(60),
</span><span class="ln"> 6 </span><span class="literal string single">...    email VARCHAR(255),
</span><span class="ln"> 7 </span><span class="literal string single">...    PRIMARY KEY (id)
</span><span class="ln"> 8 </span><span class="literal string single">... );'''</span><span class="operator">.</span><span class="name">format</span><span class="punctuation">(</span><span class="name">table_name</span><span class="operator">=</span><span class="name">tblname</span><span class="punctuation">)</span>
<span class="ln"> 9 </span>
<span class="ln">10 </span>
<span class="ln">11 </span><span class="operator">&gt;&gt;&gt;</span> <span class="keyword">print</span><span class="punctuation">(</span><span class="name">create_tbl_users</span><span class="punctuation">)</span>         <span class="comment single"># doctest: +NORMALIZE_WHITESPACE</span>
<span class="ln">12 </span><span class="name">CREATE</span> <span class="name">TABLE</span> <span class="name">users</span> <span class="punctuation">(</span>
<span class="ln">13 </span>   <span class="name builtin">id</span> <span class="name">INT</span> <span class="name">AUTO_INCREMENT</span><span class="punctuation">,</span>
<span class="ln">14 </span>   <span class="name">fname</span> <span class="name">VARCHAR</span><span class="punctuation">(</span><span class="literal number integer">40</span><span class="punctuation">),</span>
<span class="ln">15 </span>   <span class="name">sname</span> <span class="name">VARCHAR</span><span class="punctuation">(</span><span class="literal number integer">60</span><span class="punctuation">),</span>
<span class="ln">16 </span>   <span class="name">email</span> <span class="name">VARCHAR</span><span class="punctuation">(</span><span class="literal number integer">255</span><span class="punctuation">),</span>
<span class="ln">17 </span>   <span class="name">PRIMARY</span> <span class="name">KEY</span> <span class="punctuation">(</span><span class="name builtin">id</span><span class="punctuation">)</span>
<span class="ln">18 </span><span class="punctuation">);</span></code></pre>
<ul class="simple">
<li><p><strong>line 1:</strong> the <span class="docutils literal">tblname</span> variable will hold the name of the table</p></li>
<li><p><strong>lines 2-8:</strong> using the <span class="docutils literal">.format()</span> string method replace the
<span class="docutils literal">table_name</span> placeholder with the value of the <span class="docutils literal">tblname</span> variable</p></li>
<li><p><strong>line 11:</strong> show the constructed SQL statement</p></li>
</ul>
</div>
<div class="section" id="sql-statements-with-parameter-substitution">
<h3>SQL statements with parameter substitution</h3>
<p>One of the most important considerations when constructing a SQL statement is
security. Since most applications work with user provided data, which
ultimately will end up as part of a SQL query, care must be taken to sanitize
the user input. (see also: <a class="citation-reference" href="#sqlinjection" id="id18">[SQLInjection]</a>)</p>
<p>Part of the DB-API specification for database drivers is to provide
a parameter substitution. This facility is meant to take care of verifying
user input, to avoid &quot;SQL Injection&quot;-type attacks.</p>
<p>The concept of parameter substitution is very similar to how string formatting
works in Python.  Parameter style options as defined by <a class="citation-reference" href="#pep249" id="id19">[PEP249]</a> for
executing SQL statements. Drivers may implement one or more of the following
syntax:</p>
<ul class="simple">
<li><p>&quot;qmark&quot; <span class="docutils literal">?</span>: <span class="docutils literal">statement = &quot;SELECT * FROM users WHERE <span class="pre">name=?&quot;</span></span></p></li>
<li><p>&quot;numeric&quot; <span class="docutils literal">:1</span>: <span class="docutils literal">statement = &quot;SELECT * FROM users WHERE <span class="pre">name=:1&quot;</span></span></p></li>
<li><p>&quot;named&quot; <span class="docutils literal">:name</span>: <span class="docutils literal">statement = &quot;SELECT * FROM users WHERE <span class="pre">name=:name&quot;</span></span></p></li>
<li><p>&quot;format&quot; <span class="docutils literal">%s</span>: <span class="docutils literal">statement = &quot;SELECT * FROM users WHERE <span class="pre">name=%s&quot;</span></span></p></li>
<li><p>&quot;pyformat&quot; <span class="docutils literal">%(name)s</span>: <span class="docutils literal">statement = &quot;SELECT * FROM users WHERE <span class="pre">name=%(name)s&quot;</span></span></p></li>
</ul>
<p><strong>Example 3:</strong> SQL statement to add a new user:</p>
<pre class="code python python-interactive literal-block"><code><span class="ln">1 </span><span class="operator">&gt;&gt;&gt;</span> <span class="name">sql_add_user</span> <span class="operator">=</span> <span class="literal string single">'''
</span><span class="ln">2 </span><span class="literal string single">... INSERT INTO users (fname, sname, email)
</span><span class="ln">3 </span><span class="literal string single">... VALUES (?, ?, ?);
</span><span class="ln">4 </span><span class="literal string single">... '''</span>
<span class="ln">5 </span><span class="operator">&gt;&gt;&gt;</span> <span class="name">cur1</span><span class="operator">.</span><span class="name">execute</span><span class="punctuation">(</span><span class="name">sql_add_user</span><span class="punctuation">,</span> <span class="punctuation">[</span><span class="literal string single">'John'</span><span class="punctuation">,</span> <span class="literal string single">'Doe'</span><span class="punctuation">,</span> <span class="literal string single">'jdoe&#64;example.com'</span><span class="punctuation">])</span></code></pre>
<ul class="simple">
<li><p><strong>line 1-4:</strong> the variable <span class="docutils literal">sql_add_user</span> will contain the parametrized
SQL statement as a <span class="docutils literal">str</span> value</p></li>
<li><p><strong>line 3:</strong> the question marks (<span class="docutils literal">?</span>) are the placeholders, which will be
substituted by the driver with the verified parameters.</p></li>
<li><p><strong>line 5:</strong> execute the SQL statement by providing the parametrized SQL
statement <strong>and</strong> the actual values <strong>separately</strong>.</p></li>
</ul>
</div>
</div>
</div>
<div class="section" id="database-differences">
<h1><a class="toc-backref" href="#id40"><span class="sectnum">6.</span> Database differences</a></h1>
<p>Even though the SQL language is fairly standardized, there are plenty of
differences between the actual SQL commands. This problem is very hard to
solve, because</p>
<p>Example: get information about a table</p>
<ul>
<li><p>SQLite:</p>
<pre class="code python python-interactive literal-block"><code><span class="operator">&gt;&gt;&gt;</span> <span class="name">cur1</span> <span class="operator">=</span> <span class="name">conn1</span><span class="operator">.</span><span class="name">cursor</span><span class="punctuation">()</span>         <span class="comment single"># doctest: +SKIP</span>
<span class="operator">&gt;&gt;&gt;</span> <span class="name">res</span> <span class="operator">=</span> <span class="name">cur1</span><span class="operator">.</span><span class="name">execute</span><span class="punctuation">(</span><span class="literal string single">'PRAGMA table_info(&quot;users&quot;);'</span><span class="punctuation">)</span> <span class="comment single"># doctest: +SKIP</span>
<span class="operator">&gt;&gt;&gt;</span> <span class="name builtin">list</span><span class="punctuation">(</span><span class="name">cur1</span><span class="punctuation">)</span>                    <span class="comment single"># doctest: +SKIP</span>
<span class="punctuation">[(</span><span class="literal number integer">0</span><span class="punctuation">,</span> <span class="literal string single">'id'</span><span class="punctuation">,</span> <span class="literal string single">'int auto_increment'</span><span class="punctuation">,</span> <span class="literal number integer">0</span><span class="punctuation">,</span> <span class="name builtin pseudo">None</span><span class="punctuation">,</span> <span class="literal number integer">1</span><span class="punctuation">),</span>
 <span class="punctuation">(</span><span class="literal number integer">1</span><span class="punctuation">,</span> <span class="literal string single">'fname'</span><span class="punctuation">,</span> <span class="literal string single">'varchar(40)'</span><span class="punctuation">,</span> <span class="literal number integer">0</span><span class="punctuation">,</span> <span class="name builtin pseudo">None</span><span class="punctuation">,</span> <span class="literal number integer">0</span><span class="punctuation">),</span>
 <span class="punctuation">(</span><span class="literal number integer">2</span><span class="punctuation">,</span> <span class="literal string single">'sname'</span><span class="punctuation">,</span> <span class="literal string single">'varchar(60)'</span><span class="punctuation">,</span> <span class="literal number integer">0</span><span class="punctuation">,</span> <span class="name builtin pseudo">None</span><span class="punctuation">,</span> <span class="literal number integer">0</span><span class="punctuation">),</span>
 <span class="punctuation">(</span><span class="literal number integer">3</span><span class="punctuation">,</span> <span class="literal string single">'email'</span><span class="punctuation">,</span> <span class="literal string single">'varchar(255)'</span><span class="punctuation">,</span> <span class="literal number integer">0</span><span class="punctuation">,</span> <span class="name builtin pseudo">None</span><span class="punctuation">,</span> <span class="literal number integer">0</span><span class="punctuation">)]</span></code></pre>
</li>
<li><p>MariaDB:</p>
<pre class="code python python-interactive literal-block"><code><span class="operator">&gt;&gt;&gt;</span> <span class="name">cur2</span> <span class="operator">=</span> <span class="name">conn2</span><span class="operator">.</span><span class="name">cursor</span><span class="punctuation">()</span>               <span class="comment single"># doctest: +SKIP</span>
<span class="operator">&gt;&gt;&gt;</span> <span class="name">res</span> <span class="operator">=</span> <span class="name">cur2</span><span class="operator">.</span><span class="name">execute</span><span class="punctuation">(</span><span class="literal string single">'DESC users;'</span><span class="punctuation">)</span>   <span class="comment single"># doctest: +SKIP</span>
<span class="operator">&gt;&gt;&gt;</span> <span class="name builtin">list</span><span class="punctuation">(</span><span class="name">cur2</span><span class="punctuation">)</span>                          <span class="comment single"># doctest: +SKIP</span>
<span class="punctuation">[(</span><span class="literal string single">'id'</span><span class="punctuation">,</span> <span class="literal string single">'int(11)'</span><span class="punctuation">,</span> <span class="literal string single">'NO'</span><span class="punctuation">,</span> <span class="literal string single">'PRI'</span><span class="punctuation">,</span> <span class="name builtin pseudo">None</span><span class="punctuation">,</span> <span class="literal string single">'auto_increment'</span><span class="punctuation">),</span>
 <span class="punctuation">(</span><span class="literal string single">'fname'</span><span class="punctuation">,</span> <span class="literal string single">'varchar(40)'</span><span class="punctuation">,</span> <span class="literal string single">'YES'</span><span class="punctuation">,</span> <span class="literal string single">''</span><span class="punctuation">,</span> <span class="name builtin pseudo">None</span><span class="punctuation">,</span> <span class="literal string single">''</span><span class="punctuation">),</span>
 <span class="punctuation">(</span><span class="literal string single">'sname'</span><span class="punctuation">,</span> <span class="literal string single">'varchar(60)'</span><span class="punctuation">,</span> <span class="literal string single">'YES'</span><span class="punctuation">,</span> <span class="literal string single">''</span><span class="punctuation">,</span> <span class="name builtin pseudo">None</span><span class="punctuation">,</span> <span class="literal string single">''</span><span class="punctuation">),</span>
 <span class="punctuation">(</span><span class="literal string single">'email'</span><span class="punctuation">,</span> <span class="literal string single">'varchar(255)'</span><span class="punctuation">,</span> <span class="literal string single">'YES'</span><span class="punctuation">,</span> <span class="literal string single">''</span><span class="punctuation">,</span> <span class="name builtin pseudo">None</span><span class="punctuation">,</span> <span class="literal string single">''</span><span class="punctuation">)]</span></code></pre>
</li>
</ul>
<p>Note the differences:</p>
<ol class="arabic simple">
<li><p>the actual statement to execute:</p>
<ul class="simple">
<li><p>SQLite: 'PRAGMA table_info(&quot;users&quot;);'</p></li>
<li><p>MariaDB: 'DESC users;'</p></li>
</ul>
</li>
<li><p>the output:</p>
<ul class="simple">
<li><p>records are numbered by SQLite, not numbered by MariaDB</p></li>
<li><p>the data types: 'int' in SQLite vs. 'int(11) in MariaDB</p></li>
</ul>
</li>
</ol>
</div>
<div class="section" id="database-independent-python-applications">
<h1><a class="toc-backref" href="#id41"><span class="sectnum">7.</span> Database-independent Python applications</a></h1>
<p>Despite the standardized way of accessing databases in Python and the widely
used SQL language, true database-independence is difficult. The root of this
problem is the different SQL dialects used- and the different features
provided by database products.</p>
<p>As Python programmers we can choose to deal with the diversity of SQL dialects
in our code, but maintaining these differences is almost always too heavy
a burden.</p>
<p>The usual way to man a Python application database-independent is by
implementing an additional layer of abstraction in the form of an <a class="citation-reference" href="#orm" id="id20">[ORM]</a></p>
</div>
<div class="section" id="other-useful-howtos-and-tutorials">
<h1><a class="toc-backref" href="#id42"><span class="sectnum">8.</span> Other useful HOWTOs and tutorials</a></h1>
<ol class="arabic simple">
<li><p>Python PostgreSQL Tutorial Using Psycopg2
<a class="reference external" href="https://pynative.com/python-postgresql-tutorial/">https://pynative.com/python-postgresql-tutorial/</a></p></li>
<li><p>Getting Started with MySQL in Python
<a class="reference external" href="https://www.datacamp.com/community/tutorials/mysql-python">https://www.datacamp.com/community/tutorials/mysql-python</a></p></li>
<li><p>Python MySQL Tutorial Using MySQL Connector
<a class="reference external" href="https://pynative.com/python-mysql-tutorial/">https://pynative.com/python-mysql-tutorial/</a></p></li>
</ol>
</div>
<div class="section" id="showcase-application-time-sheet">
<h1><a class="toc-backref" href="#id43"><span class="sectnum">9.</span> Showcase Application: Time sheet</a></h1>
<div class="contents local topic" id="id21">
<p class="topic-title first">Contents:</p>
<ul class="auto-toc simple">
<li><p><a class="reference internal" href="#features" id="id49"><span class="sectnum">9.1.</span> Features</a></p></li>
<li><p><a class="reference internal" href="#implementation-decisions" id="id50"><span class="sectnum">9.2.</span> Implementation decisions</a></p></li>
<li><p><a class="reference internal" href="#usage" id="id51"><span class="sectnum">9.3.</span> Usage</a></p></li>
<li><p><a class="reference internal" href="#implementation-highlights" id="id52"><span class="sectnum">9.4.</span> Implementation highlights</a></p>
<ul>
<li><p><a class="reference internal" href="#usage-example" id="id53">Usage example</a></p></li>
<li><p><a class="reference internal" href="#the-functions-implemented" id="id54">The functions implemented</a></p></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="features">
<h2><a class="toc-backref" href="#id49"><span class="sectnum">9.1.</span> Features</a></h2>
<p>The time sheet application should be able to:</p>
<ol class="arabic">
<li><p>create a new time sheet database with a given schema</p></li>
<li><p>connect to an existing database</p></li>
<li><p>insert records in the tables <span class="docutils literal">users</span>, <span class="docutils literal">projects</span> and <span class="docutils literal">bookings</span>, the
values are provided on the command line, e.g.:</p>
<ul class="simple">
<li><p>users:</p></li>
</ul>
<pre class="code shell literal-block"><code>./timesheet.py --database /tmp/test.db add-user -f <span class="literal string single">'Fred'</span> <span class="literal string escape">\
</span>               --surname <span class="literal string single">'Flintstone'</span> -e <span class="literal string single">'fred.flintstone&#64;bedrock.com'</span></code></pre>
<ul class="simple">
<li><p>projects:</p></li>
</ul>
<pre class="code shell literal-block"><code>./timesheet.py --database /tmp/test.db add-project -n <span class="literal string single">'Slace Co. Crane Operator'</span></code></pre>
<ul class="simple">
<li><p>bookings:</p></li>
</ul>
<pre class="code shell literal-block"><code>./timesheet.py --database /tmp/test.db dump-table -H -f csv bookings</code></pre>
</li>
<li><p>dump all records from the tables.</p></li>
<li><p>support (only) the SQLite database</p></li>
</ol>
</div>
<div class="section" id="implementation-decisions">
<h2><a class="toc-backref" href="#id50"><span class="sectnum">9.2.</span> Implementation decisions</a></h2>
<p>A few considerations with regards to the implementation:</p>
<ol class="arabic simple">
<li><p>To keep the implementation simple:</p>
<ul class="simple">
<li><p>limit error-checking and helpful suggestions to users</p></li>
<li><p>limit the capabilities of the program</p></li>
</ul>
</li>
<li><p>Each action will be implemented by function</p></li>
<li><p>Make use of the <span class="docutils literal">argparse</span> module to:</p>
<ul class="simple">
<li><p>read and interpret CLI arguments</p></li>
<li><p>define the appropriate function to be executed</p></li>
</ul>
</li>
</ol>
</div>
<div class="section" id="usage">
<h2><a class="toc-backref" href="#id51"><span class="sectnum">9.3.</span> Usage</a></h2>
<p>Create a new database:</p>
<pre class="literal-block">$ ./timesheet.py --database timesheet.db create
Are you sure to delete all existing data? [y/N] y</pre>
<p>Check the database file <span class="docutils literal">timesheet.db</span>:</p>
<pre class="literal-block">$ file timesheet.db
timesheet.db: SQLite 3.x database, last written using SQLite version 3028000</pre>
<p>Check the tables in the database:</p>
<pre class="literal-block">$ sqlite3 timesheet.db &lt;&lt;&lt; .tables
bookings  projects  users</pre>
<p>Create a few new users:</p>
<pre class="literal-block">./timesheet.py --database timesheet.db add-user -f John -s Doe -e jdoe&#64;example.com
New user added, id=1
$ ./timesheet.py --database timesheet.db add-user -f Jane -s Brown -e jane.brown&#64;example.com
New user added, id=2
$ ./timesheet.py --database timesheet.db add-user -f Frank -s Green -e frankg&#64;example.com
New user added, id=3
$ ./timesheet.py --database timesheet.db add-user -f Eileen -s Smith -e eileeng&#64;example.com
New user added, id=4
$ ./timesheet.py --database timesheet.db add-user -f George -s Moss -e moss&#64;example.com
New user added, id=5</pre>
<p>Dump data from <span class="docutils literal">users</span> as CSV and with headers:</p>
<pre class="literal-block">$ ./timesheet.py --database timesheet.db dump-table  --headers  -f csv  users
id;fname;sname;email
1;John;Doe;jdoe&#64;example.com
2;Jane;Brown;jane.brown&#64;example.com
3;Frank;Green;frankg&#64;example.com
4;Eileen;Smith;eileeng&#64;example.com
5;George;Moss;moss&#64;example.com</pre>
<p>Add a few projects:</p>
<pre class="literal-block">$ ./timesheet.py --database timesheet.db add-project --name &quot;Project Roadrunner &#64;ACMECo&quot;
New project added, id=1
$ ./timesheet.py --database timesheet.db add-project --name &quot;Webshop Implementation &#64;ACMECo&quot;
New project added, id=2
$ ./timesheet.py --database timesheet.db add-project --name &quot;Security Audit &#64;ACMECo&quot;
New project added, id=3</pre>
<p>Dump data from <span class="docutils literal">projects</span>:</p>
<pre class="literal-block">$ ./timesheet.py --database timesheet.db dump-table projects
1 &quot;Project Roadrunner &#64;ACMECo&quot;
2 &quot;Webshop Implementation &#64;ACMECo&quot;
3 &quot;Security Audit &#64;ACMECo&quot;</pre>
<p>Add a few bookings for user &quot;Eileen Smith&quot; (user ID: 4) for the projects
&quot;Webshop Implementation &#64;ACMECo&quot; (project ID: 2) and
&quot;Project Roadrunner &#64;ACMECo&quot; (project ID: 1):</p>
<pre class="literal-block">$ ./timesheet.py --database timesheet.db add-booking -u 4 -p 2 -d 2019-09-02 \
                 --hours 8 --remarks 'Landingpage design'
New booking added, id=1
$ ./timesheet.py --database timesheet.db add-booking -u 4 -p 2 -d 2019-09-03 \
                 --hours 6 --remarks 'Landingpage design'
New booking added, id=2
$ ./timesheet.py --database timesheet.db add-booking --user 4 --project 1 \
                  --date 2019-09-03 --hours 2 --remarks 'Requirement analysis'
New booking added, id=3
$ ./timesheet.py --database timesheet.db add-booking --user 4 --project 4 \
                 --date 2019-09-04 --hours 8 --remarks 'Verify inventory'
New booking added, id=4
$ ./timesheet.py --database timesheet.db add-booking --user=4 --project=1 \
                 --date=2019-09-05 --hours=2 --remarks='Planning review'
New booking added, id=5</pre>
<p>Dump data from <span class="docutils literal">bookings</span> table as CSV, incl. headers. Note that the dump
contains data from multiple tables (using SQL <span class="docutils literal">JOIN</span> s):</p>
<pre class="literal-block">$ ./timesheet.py --database timesheet.db dump-table --format=csv  --headers bookings
booking_id;user_id;user_fname;user_sname;project_id;project_name;booking_date;booking_hours;booking_remarks
1;4;Eileen;Smith;2;Webshop Implementation &#64;ACMECo;2019-09-02;8;Landingpage design
2;4;Eileen;Smith;2;Webshop Implementation &#64;ACMECo;2019-09-03;6;Landingpage design
3;4;Eileen;Smith;1;Project Roadrunner &#64;ACMECo;2019-09-03;2;Requirement analysis
5;4;Eileen;Smith;1;Project Roadrunner &#64;ACMECo;2019-09-05;2;Planning review</pre>
</div>
<div class="section" id="implementation-highlights">
<h2><a class="toc-backref" href="#id52"><span class="sectnum">9.4.</span> Implementation highlights</a></h2>
<div class="section" id="usage-example">
<h3><a class="toc-backref" href="#id53">Usage example</a></h3>
<p>The main help function of the <span class="docutils literal">timesheet.py</span> application:</p>
<pre class="code shell shell-code literal-block"><code><span class="ln"> 1 </span>./timesheet.py  -h
<span class="ln"> 2 </span>usage: timesheet.py <span class="operator">[</span>-h<span class="operator">]</span> -d DATABASE
<span class="ln"> 3 </span>                    <span class="operator">{</span>create,verify,dump-table,add-user,add-project,add-booking<span class="operator">}</span>
<span class="ln"> 4 </span>                    ...
<span class="ln"> 5 </span>
<span class="ln"> 6 </span>positional arguments:
<span class="ln"> 7 </span>  <span class="operator">{</span>create,verify,dump-table,add-user,add-project,add-booking<span class="operator">}</span>
<span class="ln"> 8 </span>                        Commands
<span class="ln"> 9 </span>    create              Create the required schema
<span class="ln">10 </span>    verify              Verify <span class="keyword">if</span> the required tables exist is correct
<span class="ln">11 </span>    dump-table          Dump table contents
<span class="ln">12 </span>    add-user            Add user record
<span class="ln">13 </span>    add-project         Add project record
<span class="ln">14 </span>    add-booking         Add booking record
<span class="ln">15 </span>
<span class="ln">16 </span>optional arguments:
<span class="ln">17 </span>  -h, --help            show this <span class="name builtin">help</span> message and <span class="name builtin">exit</span>
<span class="ln">18 </span>  -d DATABASE, --database DATABASE
<span class="ln">19 </span>                        The SQLite database</code></pre>
<p>To get the function-specific help, execute the function with the <span class="docutils literal"><span class="pre">-h</span></span> or
<span class="docutils literal"><span class="pre">--help</span></span> argument:</p>
<pre class="code shell shell-code literal-block"><code><span class="ln"> 1 </span>./timesheet.py  add-booking -h
<span class="ln"> 2 </span>usage: timesheet.py add-booking <span class="operator">[</span>-h<span class="operator">]</span> <span class="operator">[</span>-u USER<span class="operator">]</span> <span class="operator">[</span>-p PROJECT<span class="operator">]</span> <span class="operator">[</span>-d DATE<span class="operator">]</span>
<span class="ln"> 3 </span>                                <span class="operator">[</span>-H HOURS<span class="operator">]</span> <span class="operator">[</span>-r REMARKS<span class="operator">]</span>
<span class="ln"> 4 </span>
<span class="ln"> 5 </span>optional arguments:
<span class="ln"> 6 </span>  -h, --help            show this <span class="name builtin">help</span> message and <span class="name builtin">exit</span>
<span class="ln"> 7 </span>  -u USER, --user USER  User ID
<span class="ln"> 8 </span>  -p PROJECT, --project PROJECT
<span class="ln"> 9 </span>                        Project ID
<span class="ln">10 </span>  -d DATE, --date DATE  The date of the booking <span class="operator">(</span>ISO format <span class="literal number">2019</span>-01-20<span class="operator">)</span>
<span class="ln">11 </span>  -H HOURS, --hours HOURS
<span class="ln">12 </span>                        The date of the booking
<span class="ln">13 </span>  -r REMARKS, --remarks REMARKS
<span class="ln">14 </span>                        A custom remark <span class="keyword">for</span> this booking</code></pre>
</div>
<div class="section" id="the-functions-implemented">
<h3><a class="toc-backref" href="#id54">The functions implemented</a></h3>
<ul>
<li><p><span class="docutils literal">parseargs</span>: CLI argument parsing function</p>
<p>With ~60 lines of code (LoC) this is the largest function in this program.
Parsing, interpreting and verifying CLI arguments is a complicated task,
which is entirely taken care of by the <span class="docutils literal">argparse</span> module from the Python
Standard Library.</p>
<p>The return value of this function is an object, which contains the function
that needs to be executed and the validated input. The last line of the
program <span class="docutils literal">arguments.func(connection, arguments)</span>, which</p>
<ul class="simple">
<li><p>will invoke the required function, stored in the `` arguments.func``
attribute,</p></li>
<li><p>with all the collected input, i.e.: the other attributes of the
<span class="docutils literal">arguments</span> object. (e.g.: <span class="docutils literal">.first_name</span>, <span class="docutils literal">.surname</span>, <span class="docutils literal">.email</span>
etc..)</p></li>
</ul>
</li>
<li><p><span class="docutils literal">dbconnect</span>: create a connection object to a database</p></li>
<li><p><span class="docutils literal">sql_exec</span>: a generic SQL execution function, this function is used to run
the appropriate SQL statement, that stands for a particular action, e.g.:
add user, add project record, dump table data etc...</p></li>
<li><p><span class="docutils literal">create_schema</span>: create a blank SQLite database with the provided name</p></li>
<li><p><span class="docutils literal">dump_table</span>: a generic table data dumper function, supporting the TXT and
CSV formats</p></li>
<li><p><span class="docutils literal">verify_tables</span>: a simple verification of the database validity by
checking whether or not all the tables are there</p></li>
<li><p><span class="docutils literal">add_new_user</span>: add a new user record to the <span class="docutils literal">users</span> table</p></li>
<li><p><span class="docutils literal">add_new_project</span>: add a new project record to the <span class="docutils literal">projects</span> table</p></li>
<li><p><span class="docutils literal">add_new_booking</span>: add a new booking record tot the <span class="docutils literal">bookings</span> table</p></li>
</ul>
<!-- vim: filetype=rst textwidth=78 foldmethod=syntax foldcolumn=3 wrap -->
<!-- vim: linebreak ruler spell spelllang=en showbreak=… shiftwidth=3 tabstop=3 -->
</div>
</div>
</div>
<div class="section" id="references">
<h1><a class="toc-backref" href="#id48"><span class="sectnum">10.</span> References</a></h1>
<dl class="citation">
<dt class="label" id="relationalmodel"><span class="brackets">RelationalModel</span></dt>
<dd><p><a class="reference external" href="https://en.wikipedia.org/wiki/Relational_model">https://en.wikipedia.org/wiki/Relational_model</a></p>
</dd>
<dt class="label" id="sql"><span class="brackets">SQL</span></dt>
<dd><p><a class="reference external" href="https://en.wikipedia.org/wiki/SQL">https://en.wikipedia.org/wiki/SQL</a></p>
</dd>
<dt class="label" id="acid"><span class="brackets">ACID</span><span class="fn-backref">(<a href="#id3">1</a>,<a href="#id11">2</a>)</span></dt>
<dd><p>The abreviation of the terms Atomicity, Consistency, Isolation and
Durability, which are the required properties of a database software to
guaranty transactional safety. (<a class="reference external" href="https://en.wikipedia.org/wiki/ACID">https://en.wikipedia.org/wiki/ACID</a>)</p>
</dd>
<dt class="label" id="mariadb"><span class="brackets"><a class="fn-backref" href="#id4">MariaDB</a></span></dt>
<dd><p>MariaDB is an open source relational database softare. MariaDB is
a fork of the MySQL database software. <a class="reference external" href="https://mariadb.com/">https://mariadb.com/</a></p>
</dd>
<dt class="label" id="pymysql"><span class="brackets"><a class="fn-backref" href="#id12">PyMySQL</a></span></dt>
<dd><p>A pure Python client library for the MariaDB/MySQL databases</p>
</dd>
<dt class="label" id="id22"><span class="brackets"><a class="fn-backref" href="#id5">PostgreSQL</a></span></dt>
<dd><p>PostgreSQL, is a free and open-source relational database
management system (RDBMS) emphasizing extensibility and technical standards
compliance.  (<a class="reference external" href="https://www.postgresql.org/">https://www.postgresql.org/</a>)</p>
</dd>
<dt class="label" id="orm"><span class="brackets"><a class="fn-backref" href="#id20">ORM</a></span></dt>
<dd><p>Object-relational Mapper is a library which allows full access to
(relational) databases without requiring to write SQL statements.
(<a class="reference external" href="https://www.fullstackpython.com/object-relational-mappers-orms.html">https://www.fullstackpython.com/object-relational-mappers-orms.html</a>)</p>
</dd>
<dt class="label" id="sqlalchemy"><span class="brackets"><a class="fn-backref" href="#id6">SQLAlchemy</a></span></dt>
<dd><p>Perhaps the most popular Python ORM (<a class="reference external" href="https://www.sqlalchemy.org/">https://www.sqlalchemy.org/</a>)</p>
</dd>
<dt class="label" id="djangoorm"><span class="brackets"><a class="fn-backref" href="#id7">DjangoORM</a></span></dt>
<dd><p>The built-in ORM of the Django web development framework</p>
</dd>
<dt class="label" id="peeweeorm"><span class="brackets"><a class="fn-backref" href="#id8">PeeweeORM</a></span></dt>
<dd><p><a class="reference external" href="https://docs.peewee-orm.com/">https://docs.peewee-orm.com/</a></p>
</dd>
<dt class="label" id="pysupporteddbs"><span class="brackets"><a class="fn-backref" href="#id10">PySupportedDBs</a></span></dt>
<dd><p><a class="reference external" href="https://wiki.python.org/moin/DatabaseInterfaces">https://wiki.python.org/moin/DatabaseInterfaces</a></p>
</dd>
<dt class="label" id="dbproginpython"><span class="brackets">DBProgInPython</span></dt>
<dd><p><a class="reference external" href="https://wiki.python.org/moin/DatabaseProgramming">https://wiki.python.org/moin/DatabaseProgramming</a></p>
</dd>
<dt class="label" id="pep249"><span class="brackets">PEP249</span><span class="fn-backref">(<a href="#id9">1</a>,<a href="#id14">2</a>,<a href="#id17">3</a>,<a href="#id19">4</a>)</span></dt>
<dd><p>Python Database API Specification v2.0
(<a class="reference external" href="https://www.python.org/dev/peps/pep-0249/">https://www.python.org/dev/peps/pep-0249/</a>)</p>
</dd>
<dt class="label" id="sqllang"><span class="brackets">SQLLang</span><span class="fn-backref">(<a href="#id1">1</a>,<a href="#id2">2</a>)</span></dt>
<dd><p><a class="reference external" href="https://en.wikipedia.org/wiki/SQL">https://en.wikipedia.org/wiki/SQL</a></p>
</dd>
<dt class="label" id="sqlinjection"><span class="brackets"><a class="fn-backref" href="#id18">SQLInjection</a></span></dt>
<dd><p>SQL Injection attacks are one of the most frequently used
hacking technique. See: <a class="reference external" href="https://www.w3schools.com/sql/sql_injection.asp">https://www.w3schools.com/sql/sql_injection.asp</a> and
<a class="reference external" href="https://en.wikipedia.org/wiki/SQL_injection">https://en.wikipedia.org/wiki/SQL_injection</a></p>
</dd>
</dl>
<!-- vim: filetype=rst textwidth=78 foldmethod=syntax foldcolumn=3 wrap -->
<!-- vim: linebreak ruler spell spelllang=en showbreak=… shiftwidth=3 tabstop=3 -->
</div>
</div>
</body>
</html>
